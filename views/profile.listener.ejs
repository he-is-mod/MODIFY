<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Listener Profile â€“ Modify</title>
  <link rel="stylesheet" href="/profile.musician.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://kit.fontawesome.com/2ff4bf09b6.js" crossorigin="anonymous"></script>
</head>

<body class="profile-page">

<div class="d-flex justify-content-start mt-4 mb-5" style="margin-left: 2rem;">
  <a href="/logout" class="btn btn-primary px-4 py-2 rounded-pill">Logout</a>
</div>



  <div class="container-fluid px-4 py-5">

    <!-- Listener Info with Upload Form -->
    <div class="profile-section d-flex flex-column align-items-center mb-5">
    <form action="/uploadProfilePic/profilePic" method="POST" enctype="multipart/form-data" class="upload-form">
        <label for="profilePictureInput" class="upload-label">
          <img
            src="<%= user.profile_picture || '/images/default-profile.png' %>"
            alt="Profile Picture"
            class="profile-pic"
          />
          <div class="upload-overlay">
            <i class="fas fa-plus"></i>
          </div>
        </label>
        <input
  type="file"
  id="profilePictureInput"
  name="profilePic"
  accept="image/*"
  hidden
  onchange="this.form.submit()"
/>

      </form>
      <h1 class="text-white mt-3"><%= user.name %></h1>
      <p class="text-muted bg-primary-subtle px-3 rounded-pill">
        <%= user.role || 'Listener' %>
      </p>
    </div>

    <!-- Most Listened Tracks -->
    <div class="glass-section p-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="text-white">Most Listened Tracks</h4>
        <span class="text-muted"><%= recentTracks.length %> track(s)</span>
      </div>

      <div class="row g-4">
        <% if (recentTracks.length === 0) { %>
          <p class="text-white">No listening history found.</p>
        <% } else { %>
          <% recentTracks.forEach(track => { %>
            <div class="col-md-6 col-lg-4">
              <div class="track-glass-card text-white">
                <h5 class="card-title text-center"><%= track.title %></h5>

                <div class="d-flex justify-content-center my-2">
                  <img
                    src="<%= track.cover || '/images/default-cover.jpg' %>"
                    alt="Cover"
                    style="width: 120px; height: 120px; object-fit: cover; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);"
                  />
                </div>

                <div class="mt-3 d-flex justify-content-center gap-4">
                  <button
                    class="btn btn-outline-light rounded-circle"
                    onclick="setTrackAndGo('<%= track.id %>')"
                  >
                    <i class="fas fa-play"></i>
                  </button>
                </div>
              </div>
            </div>
          <% }) %>
        <% } %>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer-nav">
    <div class="footer-icons d-flex justify-content-around align-items-center">
      <a href="/"><i class="fas fa-home"></i></a>
      <a href="#"><i class="fas fa-user"></i></a>
      <a href="/nowPlaying/nowPlaying"><i class="fas fa-music"></i></a>
      <a href="/search"><i class="fas fa-search"></i></a>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
  <script>
    function setTrackAndGo(trackId) {
      fetch('/nowPlaying/setCurrentTrack', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: trackId })
      })
      .then(() => window.location.href = '/nowPlaying/nowPlaying')
      .catch(error => {
        console.error(error);
        alert('Failed to load track.');
      });
    }
  </script>
</body>
</html>
